{% extends 'base.html' %}
{% load static %}
{% block content %}

<h2 class="fancy-title mb-3">Drag & Drop Product Uploader</h2>

<!-- Export categories safely -->
{{ categories|json_script:"cats-data" }}

<div class="card p-3 mb-3">
  <div id="dropzone" class="dropzone">
    <div class="dz-instructions">
      <div>ðŸ“¦ Drag & drop images here</div>
      <small class="text-muted">JPG, PNG, or WEBP. You can also click to pick files.</small>
    </div>
    <input id="file-input" type="file" accept="image/*" multiple hidden>
  </div>
</div>

<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">Staged products</h5>
    <div class="d-flex gap-2">
      <button id="btn-clear" class="btn btn-outline-light btn-sm">Clear</button>
      <button id="btn-upload" class="btn btn-success btn-sm" disabled>Upload all</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-dark align-middle mb-0">
      <thead>
        <tr>
          <th>Preview</th>
          <th style="min-width:240px;">Name</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Price (USD)</th>
          <th>Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div id="post-actions" class="d-none mt-3">
    <a href="{% url 'shop:product_list' %}" class="btn btn-primary">View catalog</a>
  </div>
</div>

<script>
(function(){
  const CATEGORIES = JSON.parse(document.getElementById('cats-data').textContent);

  const dropzone  = document.getElementById('dropzone');
  const fileInput = document.getElementById('file-input');
  const rows      = document.getElementById('rows');
  const btnUpload = document.getElementById('btn-upload');
  const btnClear  = document.getElementById('btn-clear');
  const afterBox  = document.getElementById('post-actions');

  function fileBaseName(file){
    const n = file.name.replace(/\.[^.]+$/, '');
    return n.replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim();
  }

  function makeRow(file){
    const url = URL.createObjectURL(file);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${url}" style="width:70px;height:70px;object-fit:contain;border-radius:8px"/></td>
      <td><input class="form-control form-control-sm" value="${fileBaseName(file)}"></td>
      <td><input class="form-control form-control-sm" placeholder="Brand"></td>
      <td>
        <select class="form-select form-select-sm">
          ${CATEGORIES.map(c=>`<option value="${c.replace(/"/g,'&quot;')}">${c}</option>`).join('')}
        </select>
      </td>
      <td style="width:110px"><input type="number" min="0" step="0.01" class="form-control form-control-sm" value="49.99"></td>
      <td class="status small">Ready</td>
      <td class="text-end">
        <button class="btn btn-outline-danger btn-sm btn-remove" type="button">Remove</button>
        <button class="btn btn-outline-warning btn-sm btn-cancel d-none" type="button" title="Delete created product">Cancel</button>
      </td>
    `;
    tr._file = file;
    tr.querySelector('.btn-remove').addEventListener('click', ()=>{ tr.remove(); updateButtons(); });
    tr.querySelector('.btn-cancel').addEventListener('click', ()=> cancelCreated(tr));
    rows.prepend(tr);
  }

  function updateButtons(){
    btnUpload.disabled = rows.querySelectorAll('tr').length === 0;
  }

  function highlight(on){ dropzone.classList.toggle('hover', !!on); }
  ['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); highlight(true); }));
  ['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); highlight(false); }));
  dropzone.addEventListener('drop', e=>{
    const files = Array.from(e.dataTransfer?.files || []).filter(f=>f.type.startsWith('image/'));
    files.forEach(makeRow); updateButtons();
  });
  dropzone.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change', ()=>{
    Array.from(fileInput.files).forEach(makeRow);
    fileInput.value=''; updateButtons();
  });

  // Upload all rows
  btnUpload.addEventListener('click', async ()=>{
    btnUpload.disabled = true; afterBox.classList.add('d-none');
    const trs = Array.from(rows.querySelectorAll('tr'));
    let anySuccess = false;

    for(const tr of trs){
      const [nameEl, brandEl, catEl, priceEl] = tr.querySelectorAll('input, select');
      const status  = tr.querySelector('.status');
      status.textContent = 'Uploadingâ€¦';

      const fd = new FormData();
      fd.append('name', nameEl.value.trim() || 'New Product');
      fd.append('brand', brandEl.value.trim());
      fd.append('category', catEl.value);
      fd.append('price', priceEl.value || '0');
      fd.append('image', tr._file);

      try{
        const resp = await fetch("{% url 'shop:uploader_api_create' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': window.__csrftoken, 'X-Requested-With':'XMLHttpRequest'},
          body: fd
        });

        if (resp.redirected) {
          status.textContent = 'Login required';
          status.classList.add('text-warning');
          window.__showToast?.('Please log in to upload');
          btnUpload.disabled = false;
          return;
        }

        let data, text;
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) data = await resp.json(); else text = await resp.text();

        if (resp.ok && data && data.ok){
          status.textContent = 'Created âœ“';
          status.classList.remove('text-danger','text-muted');
          status.classList.add('text-success');
          tr._createdId = data.id;                                   // store created product id
          tr.querySelector('.btn-cancel').classList.remove('d-none'); // show Cancel button
          anySuccess = true;
        } else {
          const msg = (data && (data.message || data.error)) || (text ? text.slice(0,180)+'â€¦' : `HTTP ${resp.status}`);
          status.textContent = msg;
          status.classList.add('text-danger');
        }
      }catch(err){
        status.textContent = (err && err.message) ? err.message : 'Network error';
        status.classList.add('text-danger');
      }
    }

    if (anySuccess){
      window.__showToast?.('Upload complete');
      afterBox.classList.remove('d-none');
    }
    btnUpload.disabled = rows.querySelectorAll('tr').length === 0;
  });

  async function cancelCreated(tr){
    if (!tr._createdId) return;
    const status = tr.querySelector('.status');
    status.textContent = 'Cancellingâ€¦';
    try{
      const resp = await fetch(`{% url 'shop:uploader_api_delete' 0 %}`.replace('0/', tr._createdId + '/'), {
        method: 'POST',
        headers: {'X-CSRFToken': window.__csrftoken, 'X-Requested-With':'XMLHttpRequest'}
      });
      const ct = resp.headers.get('content-type') || '';
      let data = ct.includes('application/json') ? await resp.json() : {};
      if (resp.ok && data.ok){
        status.textContent = 'Cancelled';
        status.classList.remove('text-success'); status.classList.add('text-warning');
        tr.remove(); updateButtons();
      } else {
        status.textContent = (data && (data.message || data.error)) || `HTTP ${resp.status}`;
        status.classList.add('text-danger');
      }
    }catch(err){
      status.textContent = 'Network error';
      status.classList.add('text-danger');
    }
  }

  btnClear.addEventListener('click', ()=>{
    rows.innerHTML=''; updateButtons(); afterBox.classList.add('d-none');
  });
})();
</script>
{% endblock %}
