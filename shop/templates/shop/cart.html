{% extends 'base.html' %}
{% block content %}
<h2 class="fancy-title mb-3">Your Cart</h2>
<div class="card p-3">
  {% if items %}
  <div class="table-responsive">
    <table class="table table-dark align-middle">
      <thead><tr><th>Product</th><th style="width:120px">Qty</th><th>Price</th><th>Subtotal</th><th></th></tr></thead>
      <tbody>
      {% for it in items %}
      <tr id="row-{{ it.product.id }}">
        <td>{{ it.product.name }}</td>
        <td>
          <form class="js-qty d-inline" action="{% url 'shop:update_qty' it.product.id %}" method="post">
            {% csrf_token %}
            <input class="form-control form-control-sm" style="width:78px" type="number" name="qty" value="{{ it.qty }}" min="0">
          </form>
        </td>
        <td>${{ it.product.price }}</td>
        <td class="sub" data-id="{{ it.product.id }}">${{ it.subtotal }}</td>
        <td>
          <form class="js-remove d-inline" action="{% url 'shop:remove_item' it.product.id %}" method="post">{% csrf_token %}
            <button class="btn btn-outline-danger btn-sm">Remove</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="text-end">
    <h4>Total: $<span id="total">{{ total }}</span></h4>
    <a class="btn btn-success" href="{% url 'shop:checkout' %}">Checkout</a>
  </div>
  {% else %}
  <div class="text-center py-5">Your cart is empty.</div>
  {% endif %}
</div>

<script>
(function(){
  document.querySelectorAll('form.js-qty').forEach(f=>{
    f.addEventListener('change', e=>{
      fetch(f.action,{method:'POST',body:new FormData(f),headers:{'X-CSRFToken':window.__csrftoken,'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(d=>{
        if(d?.ok){ document.getElementById('total').textContent=d.total; const s=document.querySelector('.sub[data-id="'+f.action.split('/').slice(-2,-1)[0]+'"]'); if(s) s.textContent='$'+d.item_subtotal; window.__updateCartBadge?.(d.count); }
      });
    });
  });
  document.querySelectorAll('form.js-remove').forEach(f=>{
    f.addEventListener('submit', e=>{
      e.preventDefault();
      fetch(f.action,{method:'POST',body:new FormData(f),headers:{'X-CSRFToken':window.__csrftoken,'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(d=>{ if(d?.ok){ f.closest('tr').remove(); document.getElementById('total').textContent=d.total; window.__updateCartBadge?.(d.count); }});
    });
  });
})();
</script>
{% endblock %}
