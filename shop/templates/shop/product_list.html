{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-3">
    <div class="card glass-card p-3">
      <h5 class="mb-3">Categories</h5>
      <ul class="list-unstyled vstack gap-2">
        <li><a class="link-light" href="{% url 'shop:product_list' %}">All parts</a></li>
        {% for c in categories %}
        <li><a class="link-light{% if request.GET.cat == c %} fw-bold{% endif %}" href="?cat={{ c|urlencode }}">{{ c }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-lg-9">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
      {% for p in products %}
      <div class="col" id="prod-card-{{ p.id }}">
        <div class="card h-100 reveal position-relative product-card">
          {% if request.user.is_staff %}
          <button class="btn btn-sm btn-outline-danger position-absolute" style="top:.75rem;right:.75rem" data-del-id="{{ p.id }}" title="Delete">ðŸ—‘</button>
          {% endif %}
          <div class="d-flex align-items-center justify-content-center" style="height:180px;">
            {% if p.image %}
              <img src="{{ p.image.url }}" alt="{{ p.name }}" class="img-fluid"
                   style="max-height:100%;object-fit:contain;">
            {% elif p.image_url %}
              <img src="{{ p.image_url }}" alt="{{ p.name }}" class="img-fluid"
                   style="max-height:100%;object-fit:contain;">
            {% else %}
              <div class="text-muted">No image</div>
            {% endif %}
          </div>
          <div class="card-body pb-4">
            <div class="tagline mb-2">{{ p.category }}{% if p.brand %} â€¢ {{ p.brand.name }}{% endif %}</div>
            <h6 class="mb-2">{{ p.name }}</h6>
            <div class="d-flex justify-content-between align-items-center">
              <strong>${{ p.price }}</strong>
              <form class="d-inline js-add" method="post" action="{% url 'shop:add_item' p.id %}">
                {% csrf_token %}
                <input type="hidden" name="qty" value="1">
                <button class="btn btn-primary btn-sm" type="submit">Add to cart</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col"><div class="card glass-card p-5 text-center">No products yet.</div></div>
      {% endfor %}
    </div>

    <div class="mt-4">
      <nav><ul class="pagination">
        {% if products.has_previous %}
        <li class="page-item"><a class="page-link" href="?{% if request.GET.cat %}cat={{request.GET.cat|urlencode}}&{% endif %}page={{ products.previous_page_number }}">Previous</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ products.number }} of {{ products.paginator.num_pages }}</span></li>
        {% if products.has_next %}
        <li class="page-item"><a class="page-link" href="?{% if request.GET.cat %}cat={{request.GET.cat|urlencode}}&{% endif %}page={{ products.next_page_number }}">Next</a></li>
        {% endif %}
      </ul></nav>
    </div>
  </div>
</div>

<script>
(function(){
  document.querySelectorAll('.js-fade-image').forEach(img=>{
    const markLoaded=()=>img.classList.add('loaded');
    if(img.complete){markLoaded();}
    else{img.addEventListener('load',markLoaded,{once:true});img.addEventListener('error',markLoaded,{once:true});}
  });

  document.querySelectorAll('form.js-add').forEach(f=>{
    f.addEventListener('submit', e=>{
      e.preventDefault();
      fetch(f.action,{method:'POST',body:new FormData(f),headers:{'X-CSRFToken':window.__csrftoken,'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(d=>{ if(d?.ok){ window.__updateCartBadge?.(d.count); window.__showToast?.('Added to cart'); }});
    });
  });
  document.querySelectorAll('[data-del-id]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      if(!confirm('Delete this product?')) return;
      const id = btn.getAttribute('data-del-id');
      fetch(`{% url 'shop:product_delete' 0 %}`.replace('0/', id+'/'),{method:'POST',headers:{'X-CSRFToken':window.__csrftoken,'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(d=>{
        if(d?.ok){ const card=document.getElementById('prod-card-'+id); if(card){ card.remove(); } window.__showToast?.('Product deleted'); }
      });
    });
  });
})();
</script>
{% endblock %}
