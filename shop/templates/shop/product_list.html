{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="row reveal">
  <div class="col-lg-3 mb-4">
    <div class="list-group">
      <a href="{% url 'shop:product_list' %}" class="list-group-item list-group-item-action {% if not request.GET.cat %}active{% endif %}">All parts</a>
      {% if categories %}
        {% for c in categories %}
        <a href="?cat={{ c|urlencode }}" class="list-group-item list-group-item-action {% if request.GET.cat == c %}active{% endif %}">{{ c }}</a>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  <div class="col-lg-9">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="fancy-title mb-0">{% if request.GET.cat %}{{ request.GET.cat }}{% else %}Our top sellers{% endif %}</h2>
      <span class="text-muted">{{ products.paginator.count }} items</span>
    </div>

    <div class="row g-3">
      {% for p in products %}
      <div class="col-sm-6 col-md-4 reveal">
        <div class="card h-100 shadow-sm">
          {% if p.image %}
            <img src="{{ p.image.url }}" class="card-img-top p-3" alt="{{ p.name }}">
          {% elif p.image_url %}
            <img src="{{ p.image_url }}" class="card-img-top p-3" alt="{{ p.name }}">
          {% else %}
            <div class="d-flex align-items-center justify-content-center bg-light text-dark" style="height:200px;">No image</div>
          {% endif %}
          <div class="card-body d-flex flex-column">
            <small class="text-uppercase" style="color:var(--muted)">{{ p.category }}</small>
            <h5 class="card-title mt-1">{{ p.name }}</h5>
            <div class="mt-auto d-flex justify-content-between align-items-center">
              <strong>${{ p.price }}</strong>
              <form class="add-to-cart" method="post" action="{% url 'shop:add_item' p.id %}">
                {% csrf_token %}
                <input type="hidden" name="qty" value="1">
                <button class="btn btn-primary btn-sm" type="submit">Add to cart</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <p>No products yet.</p>
      {% endfor %}
    </div>

    <nav class="mt-4 reveal">
      <ul class="pagination">
        {% if products.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ products.previous_page_number }}{% if request.GET.cat %}&cat={{ request.GET.cat|urlencode }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">Previous</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ products.number }} / {{ products.paginator.num_pages }}</span></li>
        {% if products.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ products.next_page_number }}{% if request.GET.cat %}&cat={{ request.GET.cat|urlencode }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<script>
  // AJAX add-to-cart with toast + badge
  document.querySelectorAll('form.add-to-cart').forEach(function(form){
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const btn=form.querySelector('button[type="submit"]'); const txt=btn.textContent;
      btn.disabled=true; btn.textContent='Adding…';

      fetch(form.action, {
        method:'POST',
        headers:{'X-CSRFToken':window.__csrftoken,'X-Requested-With':'XMLHttpRequest'},
        body:new FormData(form)
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && data.ok){
          window.__updateCartBadge?.(data.count);
          window.__showToast?.('Added to cart');
          btn.textContent='Added ✓';
        } else {
          btn.textContent='Try again';
        }
        setTimeout(()=>{btn.textContent=txt; btn.disabled=false;},900);
      })
      .catch(()=>{
        btn.textContent='Error';
        setTimeout(()=>{btn.textContent=txt; btn.disabled=false;},1200);
      });
    });
  });
</script>
{% endblock %}
